<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f0f">
    <title>What's On?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            -webkit-tap-highlight-color: transparent;
            background: #0f0f0f;
            min-height: 100vh;
        }
        
        /* Horizontal scroll row */
        .show-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            padding: 8px 0;
            scrollbar-width: none;
        }
        .show-row::-webkit-scrollbar {
            display: none;
        }
        
        /* Show card - Trakt/Netflix style */
        .show-card {
            flex: 0 0 140px;
            scroll-snap-align: start;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        .show-card:hover {
            transform: scale(1.05);
        }
        .show-card:active {
            transform: scale(0.98);
        }
        
        .show-poster {
            width: 140px;
            height: 210px;
            object-fit: cover;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .show-poster-placeholder {
            width: 140px;
            height: 210px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }
        
        .show-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.95));
        }
        
        .show-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .show-meta {
            font-size: 0.65rem;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .show-progress {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            color: #10b981;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .show-new-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #ef4444;
            color: white;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        
        .service-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        
        .service-max { background: #0052ff; }
        .service-appletv { background: linear-gradient(135deg, #fa233b, #fb5c74); }
        .service-hulu { background: #1ce783; }
        .service-peacock { background: linear-gradient(135deg, #ffd700, #ff6b00); }
        .service-paramount { background: #0068ff; }
        .service-primevideo { background: #00a8e1; }
        .service-netflix { background: #e50914; }
        .service-disney { background: linear-gradient(135deg, #113ccf, #0063e5); }
        .service-other { background: #8b5cf6; }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            padding-left: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 50;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #1a1a1a;
            border-radius: 1rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 340px;
            border: 1px solid #333;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .add-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            z-index: 40;
        }
    </style>
</head>
<body class="text-gray-100 px-4 pt-4 pb-24">
    <header class="mb-4">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <span class="text-3xl">üèîÔ∏è</span>
                <div>
                    <h1 class="text-2xl font-bold text-white">What's On?</h1>
                    <p class="text-gray-500 text-xs">{{ priority_shows|length + backup_shows|length }} active shows</p>
                </div>
            </div>
            <button onclick="openAddModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1 rounded-lg text-sm font-medium">+ Add</button>
        </div>
        
        <!-- Action buttons row -->
        <div class="flex gap-2 overflow-x-auto pb-2">
            <button onclick="fetchAllPosters()" class="flex-shrink-0 bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-lg text-xs border border-gray-700">üñºÔ∏è Posters</button>
            <button onclick="fetchAllTrakt()" class="flex-shrink-0 bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-lg text-xs border border-gray-700">üìÖ Air Days</button>
            <button onclick="loadRecommendations()" class="flex-shrink-0 bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-lg text-xs border border-gray-700">üí° Recommend</button>
        </div>
    </header>

    {% if priority_shows %}
    <section class="mb-8">
        <h2 class="section-title">
            <span class="text-emerald-400">‚ñ∂</span> Priority Shows
        </h2>
        <div class="show-row">
            {% for show in priority_shows %}
            <div class="show-card" onclick="openEdit({{ show.id }}, '{{ show.title|e }}', {{ show.current_season }}, {{ show.current_episode }}, '{{ show.service }}', '{{ show.status }}')">
                {% if show.poster_url %}
                <img src="{{ show.poster_url }}" alt="{{ show.title }}" class="show-poster">
                {% else %}
                <div class="show-poster-placeholder">üì∫</div>
                {% endif %}
                
                {% if show.air_day %}
                <div class="show-new-badge">{{ show.air_day[:3] }}</div>
                {% endif %}
                
                <div class="show-progress">
                    {% if show.current_episode == 99 %}‚úì{% else %}S{{ show.current_season }}E{{ show.current_episode }}{% endif %}
                </div>
                
                <div class="show-info">
                    <div class="show-title">{{ show.title }}</div>
                    <div class="show-meta">
                        <span class="service-dot service-{{ show.service|lower|replace(' ', '')|replace('+', '') }}"></span>
                        {{ show.service }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if backup_shows %}
    <section class="mb-8">
        <h2 class="section-title">
            <span class="text-amber-400">‚óê</span> When Nothing Else Is On
        </h2>
        <div class="show-row">
            {% for show in backup_shows %}
            <div class="show-card" onclick="openEdit({{ show.id }}, '{{ show.title|e }}', {{ show.current_season }}, {{ show.current_episode }}, '{{ show.service }}', '{{ show.status }}')" style="opacity: 0.85">
                {% if show.poster_url %}
                <img src="{{ show.poster_url }}" alt="{{ show.title }}" class="show-poster">
                {% else %}
                <div class="show-poster-placeholder">üì∫</div>
                {% endif %}
                
                {% if show.air_day %}
                <div class="show-new-badge">{{ show.air_day[:3] }}</div>
                {% endif %}
                
                <div class="show-progress">
                    {% if show.current_episode == 99 %}‚úì{% else %}S{{ show.current_season }}E{{ show.current_episode }}{% endif %}
                </div>
                
                <div class="show-info">
                    <div class="show-title">{{ show.title }}</div>
                    <div class="show-meta">
                        <span class="service-dot service-{{ show.service|lower|replace(' ', '')|replace('+', '') }}"></span>
                        {{ show.service }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if catching_up %}
    <section class="mb-8">
        <h2 class="section-title">
            <span class="text-blue-400">‚è≥</span> Catching Up
        </h2>
        <div class="show-row">
            {% for show in catching_up %}
            <div class="show-card" onclick="openEdit({{ show.id }}, '{{ show.title|e }}', {{ show.current_season }}, {{ show.current_episode }}, '{{ show.service }}', '{{ show.status }}')">
                {% if show.poster_url %}
                <img src="{{ show.poster_url }}" alt="{{ show.title }}" class="show-poster">
                {% else %}
                <div class="show-poster-placeholder">üì∫</div>
                {% endif %}
                
                <div class="show-progress" style="background: rgba(59, 130, 246, 0.9);">
                    S{{ show.current_season }}E{{ show.current_episode }}
                </div>
                
                <div class="show-info">
                    <div class="show-title">{{ show.title }}</div>
                    <div class="show-meta">
                        <span class="service-dot service-{{ show.service|lower|replace(' ', '')|replace('+', '') }}"></span>
                        {{ show.service }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Recommendations Row -->
    <section id="recsSection" class="mb-8 hidden">
        <h2 class="section-title">
            <span class="text-purple-400">üí°</span> Recommended For You
            <button onclick="loadRecommendations()" class="ml-auto text-xs text-gray-500 hover:text-white">‚Üª Refresh</button>
        </h2>
        <div id="recsRow" class="show-row">
            <!-- Populated by JavaScript -->
        </div>
    </section>

    {% if between_seasons %}
    <section class="mb-8">
        <h2 class="section-title">
            <span class="text-gray-500">üí§</span> Between Seasons
        </h2>
        <div class="show-row">
            {% for show in between_seasons %}
            <div class="show-card" onclick="openEdit({{ show.id }}, '{{ show.title|e }}', {{ show.current_season }}, {{ show.current_episode }}, '{{ show.service }}', '{{ show.status }}')" style="opacity: 0.5; filter: grayscale(50%);">
                {% if show.poster_url %}
                <img src="{{ show.poster_url }}" alt="{{ show.title }}" class="show-poster">
                {% else %}
                <div class="show-poster-placeholder">üì∫</div>
                {% endif %}
                
                <div class="show-info">
                    <div class="show-title">{{ show.title }}</div>
                    <div class="show-meta">
                        {% if show.notes %}{{ show.notes }}{% else %}Waiting for S{{ show.current_season + 1 }}{% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="editTitle" class="text-lg font-bold text-white mb-1">Edit Show</h3>
            <p id="editService" class="text-gray-400 text-sm mb-4"></p>
            <form id="editForm" method="POST">
                <div class="flex gap-4 mb-4">
                    <div class="flex-1">
                        <label class="block text-gray-400 text-xs mb-1">Season</label>
                        <input type="number" name="season" id="editSeason" min="1" 
                            class="w-full bg-gray-800 text-white text-2xl font-bold text-center p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="block text-gray-400 text-xs mb-1">Episode</label>
                        <input type="number" name="episode" id="editEpisode" min="1"
                            class="w-full bg-gray-800 text-white text-2xl font-bold text-center p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                    </div>
                </div>
                
                <button type="submit" 
                    class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-medium mb-3">
                    Save Progress
                </button>
                
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button type="button" onclick="quickAction('next')" 
                        class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-sm">
                        +1 Episode
                    </button>
                    <button type="button" onclick="quickAction('caught-up')" 
                        class="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm">
                        Caught Up ‚úì
                    </button>
                </div>
                
                <div class="flex gap-2 pt-2 border-t border-gray-700">
                    <button type="button" onclick="quickAction('hiatus')" 
                        class="flex-1 text-gray-400 text-xs py-2 hover:text-white">
                        Season Over üí§
                    </button>
                    <button type="button" onclick="quickAction('active')" id="activeBtn"
                        class="flex-1 text-emerald-400 text-xs py-2 hover:text-emerald-300 hidden">
                        New Season! üéâ
                    </button>
                    <button type="button" onclick="closeEdit()" 
                        class="flex-1 text-gray-400 text-xs py-2 hover:text-white">
                        Cancel
                    </button>
                </div>
                
                <div class="pt-3 mt-3 border-t border-gray-700">
                    <button type="button" onclick="playOnRoku()" 
                        class="w-full bg-purple-700 hover:bg-purple-600 text-white py-2 rounded-lg text-sm mb-2">
                        üì∫ Play on Roku
                    </button>
                    <button type="button" onclick="deleteShow()" 
                        class="w-full text-red-400 text-xs py-2 hover:text-red-300 hover:bg-red-900/20 rounded">
                        üóëÔ∏è Delete Show
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Show Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-white mb-4">Add Show</h3>
            <form action="/api/shows" method="POST">
                <div class="mb-3">
                    <label class="block text-gray-400 text-xs mb-1">Show Title</label>
                    <input type="text" name="title" required placeholder="e.g., The Bear"
                        class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-400 text-xs mb-1">Streaming Service</label>
                    <select name="service" required
                        class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                        <option value="Max">Max</option>
                        <option value="Apple TV+">Apple TV+</option>
                        <option value="Hulu">Hulu</option>
                        <option value="Netflix">Netflix</option>
                        <option value="Peacock">Peacock</option>
                        <option value="Paramount+">Paramount+</option>
                        <option value="Prime Video">Prime Video</option>
                        <option value="Disney+">Disney+</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="flex gap-3 mb-3">
                    <div class="flex-1">
                        <label class="block text-gray-400 text-xs mb-1">Season</label>
                        <input type="number" name="current_season" value="1" min="1"
                            class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="block text-gray-400 text-xs mb-1">Episode</label>
                        <input type="number" name="current_episode" value="1" min="1"
                            class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="block text-gray-400 text-xs mb-1">Priority</label>
                    <select name="priority"
                        class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                        <option value="1">üü¢ Priority - Watch First</option>
                        <option value="2" selected>üîµ Regular</option>
                        <option value="3">‚ö™ Backup - When Nothing Else On</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-400 text-xs mb-1">Air Day (optional)</label>
                    <select name="air_day"
                        class="w-full bg-gray-800 text-white p-3 rounded-lg border border-gray-700 focus:border-emerald-500 focus:outline-none">
                        <option value="">Not set</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button type="button" onclick="closeAddModal()" 
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-medium">
                        Add Show
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentShowId = null;
        let currentStatus = null;

        function openEdit(id, title, season, episode, service, status) {
            currentShowId = id;
            currentStatus = status;
            document.getElementById('editTitle').textContent = title;
            document.getElementById('editService').textContent = service;
            document.getElementById('editSeason').value = season;
            document.getElementById('editEpisode').value = episode === 99 ? 1 : episode;
            document.getElementById('editForm').action = '/edit-show/' + id;
            
            // Show "New Season" button if on hiatus
            document.getElementById('activeBtn').classList.toggle('hidden', status !== 'hiatus');
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEdit() {
            document.getElementById('editModal').classList.remove('active');
            currentShowId = null;
        }

        function deleteShow() {
            if (!currentShowId) return;
            const title = document.getElementById('editTitle').textContent;
            if (confirm(`Delete "${title}"? This cannot be undone.`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/delete-show/' + currentShowId;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function quickAction(action) {
            if (!currentShowId) return;
            
            const form = document.createElement('form');
            form.method = 'POST';
            
            switch(action) {
                case 'next':
                    form.action = '/next-episode/' + currentShowId;
                    break;
                case 'caught-up':
                    form.action = '/mark-caught-up/' + currentShowId;
                    break;
                case 'hiatus':
                    form.action = '/mark-hiatus/' + currentShowId;
                    break;
                case 'active':
                    form.action = '/mark-active/' + currentShowId;
                    break;
            }
            
            document.body.appendChild(form);
            form.submit();
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        async function fetchAllPosters() {
            try {
                const response = await fetch('/api/fetch-all-posters', { method: 'POST' });
                const data = await response.json();
                if (data.updated > 0) {
                    location.reload();
                } else {
                    alert('All posters already fetched!');
                }
            } catch (err) {
                alert('Error fetching posters');
            }
        }

        async function fetchAllTrakt() {
            try {
                const response = await fetch('/api/fetch-all-trakt', { method: 'POST' });
                const data = await response.json();
                if (data.updated > 0) {
                    alert(`Updated air days for ${data.updated} shows!`);
                    location.reload();
                } else {
                    alert('All shows already have air days set!');
                }
            } catch (err) {
                alert('Error fetching from Trakt');
            }
        }

        async function showRecommendations() {
            loadRecommendations();
        }

        async function loadRecommendations() {
            const section = document.getElementById('recsSection');
            const row = document.getElementById('recsRow');
            
            row.innerHTML = '<div class="text-gray-500 text-sm p-4">Loading recommendations...</div>';
            
            try {
                const response = await fetch('/api/recommendations');
                const data = await response.json();
                
                if (data.recommendations && data.recommendations.length > 0) {
                    row.innerHTML = data.recommendations.map(show => `
                        <div class="show-card rec-card" style="border: 2px solid #a855f7;">
                            ${show.poster_url 
                                ? `<img src="${show.poster_url}" alt="${show.title}" class="show-poster">`
                                : `<div class="show-poster-placeholder">üì∫</div>`
                            }
                            <div class="show-info">
                                <div class="show-title">${show.title}</div>
                                <div class="show-meta">${show.year || ''}</div>
                            </div>
                            <div class="rec-actions" style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); display:none; flex-direction:column; justify-content:center; align-items:center; gap:8px; padding:10px;">
                                <button onclick="addRec('${show.title}', '${show.trakt_slug}')" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-3 py-2 rounded-lg w-full">+ Add to List</button>
                                <button onclick="dismissRec('${show.trakt_slug}', this)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-2 rounded-lg w-full">Already Seen</button>
                                <button onclick="dismissRec('${show.trakt_slug}', this)" class="text-gray-400 hover:text-white text-xs py-1">Not Interested</button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add hover behavior
                    document.querySelectorAll('.rec-card').forEach(card => {
                        card.addEventListener('click', function(e) {
                            if (!e.target.closest('button')) {
                                const actions = this.querySelector('.rec-actions');
                                actions.style.display = actions.style.display === 'flex' ? 'none' : 'flex';
                            }
                        });
                    });
                    
                    section.classList.remove('hidden');
                } else {
                    row.innerHTML = '<div class="text-gray-500 text-sm p-4">No recommendations right now. Add more shows!</div>';
                    section.classList.remove('hidden');
                }
            } catch (err) {
                row.innerHTML = '<div class="text-red-400 text-sm p-4">Error loading recommendations</div>';
                section.classList.remove('hidden');
            }
        }

        async function addRec(title, trakt_slug) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/recommendations/add';
            
            const titleInput = document.createElement('input');
            titleInput.name = 'title';
            titleInput.value = title;
            form.appendChild(titleInput);
            
            const slugInput = document.createElement('input');
            slugInput.name = 'trakt_slug';
            slugInput.value = trakt_slug;
            form.appendChild(slugInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        async function dismissRec(trakt_slug, btn) {
            const card = btn.closest('.rec-card');
            card.style.opacity = '0.3';
            
            const formData = new FormData();
            formData.append('trakt_slug', trakt_slug);
            
            try {
                await fetch('/api/recommendations/dismiss', {
                    method: 'POST',
                    body: formData
                });
                card.remove();
                
                // If no more recs, show message
                const remaining = document.querySelectorAll('.rec-card').length;
                if (remaining === 0) {
                    document.getElementById('recsRow').innerHTML = '<div class="text-gray-500 text-sm p-4">Click "Recommend" for more suggestions</div>';
                }
            } catch (err) {
                card.style.opacity = '1';
            }
        }

        // ============ ROKU INTEGRATION ============
        const ROKU_IP = localStorage.getItem('rokuIp') || '192.168.86.220';
        
        // Service to Roku channel ID mapping
        const ROKU_CHANNELS = {
            'max': 61322,
            'hbo max': 61322,
            'apple tv+': 551012,
            'appletv+': 551012,
            'hulu': 2285,
            'netflix': 12,
            'peacock': 593099,
            'paramount+': 37102,
            'prime video': 13,
            'amazon prime': 13,
            'disney+': 291097
        };
        
        let currentService = null;
        
        function playOnRoku() {
            if (!currentService) {
                alert('No service detected for this show');
                return;
            }
            
            const service = currentService.toLowerCase();
            const channelId = ROKU_CHANNELS[service];
            
            if (!channelId) {
                alert(`Unknown service: ${currentService}. Can't launch on Roku.`);
                return;
            }
            
            // Roku ECP requires POST - use form + hidden iframe to bypass CORS
            const url = `http://${ROKU_IP}:8060/launch/${channelId}`;
            
            // Create hidden iframe as form target
            let iframe = document.getElementById('rokuFrame');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'rokuFrame';
                iframe.name = 'rokuFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = url;
            form.target = 'rokuFrame';
            document.body.appendChild(form);
            
            try {
                form.submit();
            } catch(e) {
                // Expected - cross-origin frame issues, but request still sends
            }
            
            form.remove();
            
            // Close modal and show confirmation
            closeEdit();
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-purple-600 text-white px-4 py-2 rounded-lg text-sm z-50';
            toast.textContent = `üì∫ Launching ${currentService}...`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        // Update openEdit to store current service
        const originalOpenEdit = openEdit;
        openEdit = function(id, title, season, episode, service, status) {
            currentService = service;
            originalOpenEdit(id, title, season, episode, service, status);
        };
        
        // Settings: Allow changing Roku IP
        function setRokuIp() {
            const ip = prompt('Enter your Roku IP address:', ROKU_IP);
            if (ip) {
                localStorage.setItem('rokuIp', ip);
                alert('Roku IP saved: ' + ip);
            }
        }
    </script>
</body>
</html>
